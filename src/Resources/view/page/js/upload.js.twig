"use strict";

{# @see http://stackoverflow.com/a/11277696 #}
window.URL = window.URL || window.webkitURL;

{# @see http://jsfiddle.net/46Y45/5 #}
{# @see https://tympanus.net/codrops/2015/09/15/styling-customizing-file-inputs-smart-way #}
let inputContainer = document.getElementById('upload'),
    inputFile = document.getElementById('data-import'),
    inputIcon = document.createElement('i'),
    inputLabel = inputFile.nextElementSibling,
    list = document.createElement('ol'),
    newList = [],
    textClass = '{{ colorInverse }}{{ loginFormClass|trim }} title-shadow',
    regex = /^(.*data.*\.zip)|(version)$/i;
inputFile.addEventListener('change', handleFiles, false);
inputFile.addEventListener('focus', function(){ inputFile.classList.add('has-focus'); });
inputFile.addEventListener('blur', function(){ inputFile.classList.remove('has-focus'); });
inputIcon.classList = 'fa fa-upload fa-4x';
inputLabel.appendChild(inputIcon);
inputLabel.classList = textClass+' ba br-100 dib pa3';
inputLabel.style = '-webkit-appearance: button; -moz-appearance: button; appearance: button;';
list.classList = textClass+' br2 cf mh1 mh2-ns mh3-m mh4-l ph2 pv1';

{# @see https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications#Example%3a_Using_object_URLs_to_display_images #}
function handleFiles(event) {
    inputIcon.innerHTML = '';
    inputIcon.classList.remove('fa-upload');
    inputIcon.classList.add('fa-circle-o-notch');
    inputIcon.classList.add('fa-spin');
    let files = [].slice.call(inputFile.files);
    Array.prototype.forEach.call(files, function(file) {
        if (regex.test(file.name)) {
            let reader = new FileReader();
            reader.onload = function (event) {
                let li = document.createElement('li');
                li.classList = 'list tr w-100 w-75-ns';
                li.innerText = file.webkitRelativePath;
                list.appendChild(li);
            };
            reader.readAsDataURL(file);
            newList.push(file);
        }
    });
    inputLabel.classList.remove('br-100');
    inputLabel.classList.add('br3');
    inputLabel.classList.add('ph4');
    if (newList.length) {
        handleUpload(newList.length);
    } else {
        handleField(0);
    }
}
function handleUpload(count) {
    let data = new FormData();
    data.append('user', '{{ studentCode }}');
    $.each(newList, function(i, item) { data.append('file-'+i, item); });
    $.ajax({
        url: 'save',
        type: 'POST',
        data: data,
        beforeSend: function({#xhr#}) {
            {#xhr.overrideMimeType("text/plain; charset=x-user-defined");#}
            inputLabel.classList.remove('{{ loginFormClass|trim }}');
            inputIcon.innerHTML = '';
        },
        processData: false,
        contentType: false,
        cache: false,
        dataType: 'json'{#
    }).always(function() {
        el.disabled = false;
        inputFile.value = '';
        inputIcon.classList.remove('fa-circle-o-notch');
        inputIcon.classList.remove('fa-spin');
        list.innerHTML = '';#}
    }).done(function(data, textStatus, jqXHR) {
        {#console.log(data.fresh);
        console.log(data.dupe);
        console.log(data.garb);#}
        {# File
        inputFile.disabled = true;
        inputFile.value = '';#}
        {# Label #}
        inputContainer.appendChild(list);
        handleField(count);
    }).fail(function(jqXHR, textStatus, errorThrown) {
        handleField(count);
    });
}
function handleField(count) {
    let span = document.createElement('span'),
        colorStyle = count ? 'color: {{ colorInverse }};' : 'color: red;';
    inputLabel.classList.add('bn');
    {#inputLabel.style = 'cursor: initial;';#}
    inputIcon.classList.remove('fa-circle-o-notch');
    inputIcon.classList.remove('fa-spin');
    inputIcon.classList.add('fa-upload');
    span.classList = 'cf {{ fontClassX3 }}sanf-serif';
    span.innerText = (inputFile.getAttribute('data-multiple-caption') || '').replace(/{count}/g, count.toString());
    span.style = 'font-family: sans-serif; line-height: 1.15; -webkit-text-size-adjust: 100%;' + colorStyle;
    inputIcon.innerHTML = span.outerHTML;
}