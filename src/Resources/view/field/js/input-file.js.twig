"use strict";

{# @see http://stackoverflow.com/a/11277696 #}
window.URL = window.URL || window.webkitURL;

{# @see http://jsfiddle.net/46Y45/5 #}
{# @see https://tympanus.net/codrops/2015/09/15/styling-customizing-file-inputs-smart-way/ #}
let inputFile = document.getElementById('data-import'),
    listing = document.getElementById('listing'),
    label = inputFile.nextElementSibling,
    labelVal = label.innerHTML,
    textClass = 'dib {{ colorInverse }}login-title',
    regex = /^(.*data.*\.zip)|(version)$/i;
inputFile.addEventListener('change', handleFiles, false);
let icon = document.createElement('i');
icon.classList = 'fa fa-spin fa-upload';
label.appendChild(icon);
label.classList = textClass+' br2 pa2';
label.style = '-webkit-appearance: button; appearance: button';

{# @see https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications#Example%3a_Using_object_URLs_to_display_images #}
function handleFiles(event) {
    let el = event.target,
        fileName = '',
        files = [].slice.call(el.files), //this.files, /* now you can work with the file list */
        newList = [];
    el.disabled = true;
    icon.classList.remove('fa-upload');
    icon.classList.add('fa-circle-o-notch');
    Array.prototype.forEach.call(files, function(file) {
        if (regex.test(file.name)) {
            let reader = new FileReader();
            reader.onload = function (event) {
                let li = document.createElement('li');
                li.classList = textClass+' list tr w-100 w-75-m w-75-ns';
                li.innerText = file.webkitRelativePath;
                listing.appendChild(li);
            };
            reader.readAsDataURL(file);
            newList.push(file);
        }
    });
    if (files && files.length > 1) {
        fileName = (this.getAttribute('data-multiple-caption') || '').replace('{count}', newList.length);
    } else {
        fileName = el.value.split('\\').pop();
    }
    if (fileName) {
        let span = document.createElement('span');
        label.appendChild(span);
        span.innerHTML = fileName;
    } else {
        label.innerHTML = labelVal;
    }
    let data = new FormData();
    //$.each(newList, function(i, item) { data.append('file-'+i, item); });
    Array.prototype.forEach.call(newList, function(i, item) { data.append('file-'+i, item); });
    el.value = '';
    $.ajax({
        url: 'save',
        data: data,
        {# @see http://stackoverflow.com/a/21963559 #}
        contentType: false,
        processData: false,
        cache: false,
        dataType: 'json',
        type: 'POST',
        always: function() {
            //el.disabled = false;
            inputFile.value = '';
            icon.classList.remove('fa-circle-o-notch');
            icon.classList.remove('fa-spin');
            listing.innerHTML = '';
        },
        done: function(data, textStatus, jqXHR) {
            let msg = JSON.stringify(data.msg).replace(/\"/g, '');
            if(msg != 'success') {
                icon.classList.add('fa-check');
                console.log(msg);
                {#document.getElementById('formMsg').textContent = msg;
                document.getElementById('formMsg').style = 'display: block;';#}
            }{#else {
                $("#formModal").modal('hide');
            }#}
        },
        fail: function(jqXHR, textStatus, errorThrown) {
            icon.classList.add('fa-exclamation-triangle');
            console.log(errorThrown);
            alert('Fail.');
        }
    });
}